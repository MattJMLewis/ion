const merkle = require('./merkle')
const Sodium = artifacts.require("Sodium");

contract('Sodium', (accounts) => {

  it('test JS Merkle', async () => {

    const testData = ["1","2","3","4","5","6","7"]

    const tree = merkle.createMerkle(testData)

    const expectedTree = [
      [
        [
          '8568612641526826488487436752726739043287191320122540356069953783894380777505',
          '8763638472773768691201326883407021568462294246273894496415427229083082408032',
          '19224855404247632006917173431419498680506051063941070371722880450128577361118',
          '61795459977501490647348212754130855970016313872340374962921336716751708851142',
          '64645341593328157176709656265449880868558868673380425455960412802858937540801',
          '74330811247603495249613868516695563873247293176611122272199330092769797099053',
          '78469846343542442363028680824980501212021332975324075417961003849793346933925',
          '75317570447191171753008806478868650352148013528306361601609880810432714200529'
        ],
        [
          '6560824545851281876686151142367952893930617484325436481370811303698242675212',
          '14094329272021934754728783365468382816047630355461653340632553426278198853241',
          '25919299780512511508061958642305261009583198324725036212440752482930702519878',
          '11791415309425995046749154607832041856871129882141188736462372751874115368248'
        ],
        [
          '22114525030336665972036957912787127870644756898138077124815002206627656645846',
          '74561778027252859083209130121920474961655350982938755244738788717578708084930'
        ],
        [
          '5587813875922595628752214729735723034111050560116231646359963981668986135460'
        ]
      ],
      '5587813875922595628752214729735723034111050560116231646359963981668986135460'
    ]

    assert.deepEqual(tree,expectedTree)

    const expectedPaths = [
      [
        '19224855404247632006917173431419498680506051063941070371722880450128577361118',
        '6560824545851281876686151142367952893930617484325436481370811303698242675212',
        '103509800336581907939101876374092451924972847149348896254603184719556990494914'
      ],
      [
        '104265592756520220608901552731040627315465509694716502611474276812410996610513',
        '25919299780512511508061958642305261009583198324725036212440752482930702519878',
        '22114525030336665972036957912787127870644756898138077124815002206627656645846'
      ],
      [
        '90743482286830539503240959006302832933333810038750515972785732718729991261126',
        '6560824545851281876686151142367952893930617484325436481370811303698242675212',
        '103509800336581907939101876374092451924972847149348896254603184719556990494914'
      ],
      [
        '8568612641526826488487436752726739043287191320122540356069953783894380777505',
        '43042351581350983610621529617640359779365126521871794350496949428256481263225',
        '103509800336581907939101876374092451924972847149348896254603184719556990494914'
      ],
      [
        '103278833556932544105506614768867540836564789343021263282063726094748079509037',
        '40739437618755043902641900860004018820188626048551329746326768753852397778232',
        '22114525030336665972036957912787127870644756898138077124815002206627656645846'
      ],
      [
        '64645341593328157176709656265449880868558868673380425455960412802858937540801',
        '40739437618755043902641900860004018820188626048551329746326768753852397778232',
        '22114525030336665972036957912787127870644756898138077124815002206627656645846'
      ],
      [
        '37711660782102817547094073135578998531779790412684035506279823231061364818016',
        '43042351581350983610621529617640359779365126521871794350496949428256481263225',
        '103509800336581907939101876374092451924972847149348896254603184719556990494914'
      ]
    ]

    const path = testData.map(value => merkle.pathMerkle(value,tree[0]))
    assert.deepEqual(path,expectedPaths)

    testData.forEach((leaf,idx) => assert(merkle.proofMerkle(leaf,path[idx],tree[1])))
    testData.forEach((leaf,idx) => assert(!merkle.proofMerkle('10',path[idx],tree[1])))

    // console.log(JSON.stringify(tree,2,2))
  })

  it('works', async () => {
    const obj = await Sodium.deployed();

    const root = "0x1a792cf089bfa56eae57ffe87e9b22f9c9bfe52c1ac300ea1f43f4ab53b4b794"
    const leafHash = "0x2584db4a68aa8b172f70bc04e2e74541617c003374de6eb4b295e823e5beab01"
    const path = [
      "0x1ab0c6948a275349ae45a06aad66a8bd65ac18074615d53676c09b67809099e0"
      ,"0x093fd25755220b8f497d65d2538c01ed279c131f63e42b2942867f2bd6622486"
      ,"0xb1d101d9a9d27c3a8ed9d1b6548626eacf3d19546306117eb8af547d1e97189e"
      ,"0xcb431dd627bc8dcfd858eae9304dc71a8d3f34a8de783c093188bb598eeafd04"
    ]
    const nextBlock = await obj.NextBlock()
    // console.log(nextBlock.toString())

    const receiptUpdate = await obj.Update(nextBlock.toString(),[root])
    // console.log(receiptUpdate)

    const valid = await obj.Verify(nextBlock.toString(),leafHash,path)
    // console.log(valid)
  });
});
